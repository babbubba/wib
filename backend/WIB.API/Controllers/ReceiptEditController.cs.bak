using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Globalization;
using WIB.Application.Contracts.Receipts;
using WIB.Infrastructure.Data;

namespace WIB.API.Controllers;

[ApiController]
[Authorize(Roles = "wmc")]
[Route("receipts")]
public class ReceiptEditController : ControllerBase
{
    private readonly WibDbContext _db;

    public ReceiptEditController(WibDbContext db)
    {
        _db = db;
    }

    [HttpPost("{id:guid}/edit")]
    public async Task<IActionResult> Edit(Guid id, [FromBody] EditReceiptRequest body, CancellationToken ct)
    {
        var receipt = await _db.Receipts
            .Include(r => r.Store)
            .Include(r => r.Lines)
            .FirstOrDefaultAsync(r => r.Id == id, ct);
        if (receipt == null) return NotFound();

        if (!string.IsNullOrWhiteSpace(body.StoreName))
        {
            var name = body.StoreName.Trim();
            var lower = name.ToLowerInvariant();
            var store = await _db.Stores.FirstOrDefaultAsync(s => s.Name.ToLower() == lower, ct);
            if (store == null)
            {
                var norm = CultureInfo.CurrentCulture.TextInfo.ToTitleCase(lower);
                store = new WIB.Domain.Store { Name = norm };
                _db.Stores.Add(store);
                await _db.SaveChangesAsync(ct);
            }
            receipt.StoreId = store.Id;
            receipt.Store = store;
        }

        if (body.Datetime.HasValue) receipt.Date = body.Datetime.Value;
        if (!string.IsNullOrWhiteSpace(body.Currency)) receipt.Currency = body.Currency!;
        // Optional store fields
        if (!string.IsNullOrWhiteSpace(body.StoreAddress)) receipt.Store!.Address = body.StoreAddress!.Trim();
        if (!string.IsNullOrWhiteSpace(body.StoreCity)) receipt.Store!.City = body.StoreCity!.Trim();
        if (!string.IsNullOrWhiteSpace(body.StorePostalCode)) receipt.Store!.PostalCode = body.StorePostalCode!.Trim();
        if (!string.IsNullOrWhiteSpace(body.StoreVatNumber)) receipt.Store!.VatNumber = body.StoreVatNumber!.Trim();

        if (body.Lines != null && body.Lines.Count > 0)
        {
            var arr = receipt.Lines.OrderBy(l => l.Id).ToList();
            // Apply removals first (descending by index) to avoid shifting
            var removals = body.Lines.Where(p => p.Remove == true).OrderByDescending(p => p.Index).ToList();
            foreach (var rm in removals)
            {
                if (rm.Index >= 0 && rm.Index < arr.Count)
                {
                    var line = arr[rm.Index];
                    receipt.Lines.Remove(line);
                    arr.RemoveAt(rm.Index);
                }
            }

            foreach (var patch in body.Lines.Where(p => p.Remove != true))
            {
                if (patch.Index < 0 || patch.Index >= arr.Count) continue;
                var line = arr[patch.Index];
                if (!string.IsNullOrWhiteSpace(patch.LabelRaw)) line.LabelRaw = patch.LabelRaw!.Trim();
                if (patch.Qty.HasValue) line.Qty = patch.Qty.Value;
                if (patch.UnitPrice.HasValue) line.UnitPrice = patch.UnitPrice.Value;
                if (patch.LineTotal.HasValue) line.LineTotal = patch.LineTotal.Value;
                if (patch.VatRate.HasValue) line.VatRate = patch.VatRate.Value;

                if (patch.FinalCategoryId.HasValue || !string.IsNullOrWhiteSpace(patch.FinalCategoryName))
                {
                    Guid? catId = patch.FinalCategoryId;
                    if (!catId.HasValue && !string.IsNullOrWhiteSpace(patch.FinalCategoryName))
                    {
                        var cname = patch.FinalCategoryName!.Trim();
                        var clower = cname.ToLowerInvariant();
                        var cat = await _db.Categories.FirstOrDefaultAsync(c => c.Name.ToLower() == clower, ct);
                        if (cat == null)
                        {
                            var cnorm = CultureInfo.CurrentCulture.TextInfo.ToTitleCase(clower);
                            cat = new WIB.Domain.Category { Name = cnorm };
                            _db.Categories.Add(cat);
                            await _db.SaveChangesAsync(ct);
                        }
                        catId = cat.Id;
                    }
                    if (catId.HasValue)
                    {
                        var pnameInput = !string.IsNullOrWhiteSpace(patch.ProductName) ? patch.ProductName!.Trim() : line.LabelRaw;
                        var plower = pnameInput.ToLowerInvariant();
                        var prod = await _db.Products.FirstOrDefaultAsync(p => p.CategoryId == catId && p.Name.ToLower() == plower, ct);
                        if (prod == null)
                        {
                            var pnorm = CultureInfo.CurrentCulture.TextInfo.ToTitleCase(plower);
                            prod = new WIB.Domain.Product { Name = pnorm, CategoryId = catId };
                            _db.Products.Add(prod);
                            await _db.SaveChangesAsync(ct);
                        }
                        line.ProductId = prod.Id;
                        line.PredictedCategoryId = catId; // reflect user choice
                        line.PredictionConfidence = 1.0m;
                    }
                }
            }
        }

        // Add new lines if provided
        if (body.AddLines != null && body.AddLines.Count > 0)
        {
            foreach (var add in body.AddLines)
            {
                Guid? catId = add.FinalCategoryId;
                if (!catId.HasValue && !string.IsNullOrWhiteSpace(add.FinalCategoryName))
                {
                    var cname = add.FinalCategoryName!.Trim();
                    var clower = cname.ToLowerInvariant();
                    var cat = await _db.Categories.FirstOrDefaultAsync(c => c.Name.ToLower() == clower, ct);
                    if (cat == null)
                    {
                        var cnorm = CultureInfo.CurrentCulture.TextInfo.ToTitleCase(clower);
                        cat = new WIB.Domain.Category { Name = cnorm };
                        _db.Categories.Add(cat);
                        await _db.SaveChangesAsync(ct);
                    }
                    catId = cat.Id;
                }
                WIB.Domain.Product? prod = null;
                if (catId.HasValue)
                {
                    var pname = !string.IsNullOrWhiteSpace(add.ProductName) ? add.ProductName!.Trim() : add.LabelRaw;
                    var plower = pname.ToLowerInvariant();
                    prod = await _db.Products.FirstOrDefaultAsync(p => p.CategoryId == catId && p.Name.ToLower() == plower, ct);
                    if (prod == null)
                    {
                        var pnorm = CultureInfo.CurrentCulture.TextInfo.ToTitleCase(plower);
                        prod = new WIB.Domain.Product { Name = pnorm, CategoryId = catId };
                        _db.Products.Add(prod);
                        await _db.SaveChangesAsync(ct);
                    }
                }
                var newLine = new WIB.Domain.ReceiptLine
                {
                    LabelRaw = add.LabelRaw.Trim(),
                    Qty = add.Qty,
                    UnitPrice = add.UnitPrice,
                    LineTotal = add.LineTotal,
                    VatRate = add.VatRate,
                    ProductId = prod?.Id,
                    PredictedCategoryId = prod?.CategoryId,
                    PredictionConfidence = prod != null ? 1.0m : null
                };
                receipt.Lines.Add(newLine);
            }
        }

        // Recompute receipt total if lines changed
        receipt.Total = receipt.Lines.Sum(x => x.LineTotal);

        await _db.SaveChangesAsync(ct);
        return NoContent();
    }
}


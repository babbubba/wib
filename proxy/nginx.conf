server {
  listen 80;
  server_name _;
  client_max_body_size 20m;

  # Backend API routes
  # SSE stream (disable buffering to allow real-time delivery)
  location /monitoring/logs/stream {
    proxy_pass http://api:8080/monitoring/logs/stream;
    proxy_set_header Host $host;
    proxy_set_header Authorization $http_authorization;

    # Critical for Server-Sent Events
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_buffering off;
    proxy_cache off;
    chunked_transfer_encoding on;
    proxy_read_timeout 1h;
    proxy_send_timeout 1h;
    add_header X-Accel-Buffering no always;
  }

  location /receipts {
    proxy_pass http://api:8080/receipts;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header Authorization $http_authorization;
  }

  location /categories {
    proxy_pass http://api:8080/categories;
    proxy_set_header Host $host;
    proxy_set_header Authorization $http_authorization;
  }

  location /producttypes {
    proxy_pass http://api:8080/producttypes;
    proxy_set_header Host $host;
    proxy_set_header Authorization $http_authorization;
  }

  location /stores {
    proxy_pass http://api:8080/stores;
    proxy_set_header Host $host;
    proxy_set_header Authorization $http_authorization;
  }

  location /analytics {
    proxy_pass http://api:8080/analytics;
    proxy_set_header Host $host;
    proxy_set_header Authorization $http_authorization;
  }

  location /auth {
    proxy_pass http://api:8080/auth;
    proxy_set_header Host $host;
  }

  location /queue {
    proxy_pass http://api:8080/queue;
    proxy_set_header Host $host;
    proxy_set_header Authorization $http_authorization;
  }

  location /storage {
    proxy_pass http://api:8080/storage;
    proxy_set_header Host $host;
    proxy_set_header Authorization $http_authorization;
  }

  location /monitoring {
    proxy_pass http://api:8080/monitoring;
    proxy_set_header Host $host;
    proxy_set_header Authorization $http_authorization;
  }

  location /storage/object {
    proxy_pass http://api:8080/storage/object;
    proxy_set_header Host $host;
    proxy_set_header Authorization $http_authorization;
  }

  # ML API endpoints exposed via WIB.API
  location /ml/suggestions {
    proxy_pass http://api:8080/ml/suggestions;
    proxy_set_header Host $host;
    proxy_set_header Authorization $http_authorization;
  }

  location /ml/feedback {
    proxy_pass http://api:8080/ml/feedback;
    proxy_set_header Host $host;
    proxy_set_header Authorization $http_authorization;
  }

  # Health check endpoints
  location /health {
    proxy_pass http://api:8080/health;
    proxy_set_header Host $host;
  }

  # ML and OCR passthrough (debug/health)
  location /ml/ {
    proxy_pass http://ml:8082/;
  }

  location /ocr/ {
    proxy_pass http://ocr:8081/;
  }

  # KIE endpoint
  location /kie {
    proxy_pass http://ocr:8081/kie;
  }

  # Default
  location / {
    add_header Content-Type text/plain;
    return 200 'wib-proxy';
  }
}
